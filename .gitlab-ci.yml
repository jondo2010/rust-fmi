variables:
  #CARGO_HOME: $CI_PROJECT_DIR/cargo
  #APT_CACHE_DIR: $CI_PROJECT_DIR/apt

cache:
  untracked: false
  paths:
    - cargo/
    - target/

stages:
  - build
  - test
  - docs

build:stable:cargo:
  image: registry.gitlab.com/jondo2010/rust-fmi/build-image
  stage: build
  cache:
    key: stable
  before_script:
    - rustup update stable
  script:
    - cargo +stable build --release --all
  artifacts:
    paths:
      - target/release

test:stable:cargo:
  image: registry.gitlab.com/jondo2010/rust-fmi/build-image
  stage: test
  cache:
    key: stable
  before_script:
    - rustup update stable
  script:
    - cargo +stable suity
  artifacts:
    reports:
      junit:
        - test-results/default.xml

test:nightly:cargo:
  image: registry.gitlab.com/jondo2010/rust-fmi/build-image
  stage: test
  before_script:
    - rustup toolchain add nightly
  script:
    - cargo +nightly tarpaulin --verbose --out Xml --output-dir target/tarpaulin --all 
  artifacts:
    reports:
      cobertura:
        - target/tarpaulin/cobertura.xml

pages:
  image: rust
  stage: docs 
  cache:
    key: stable
    policy: pull
  script:
    - cargo doc --all --no-deps
    - rm -rf public
    - mkdir public
    - cp -R target/doc/* public
  artifacts:
    paths:
      - public
  only:
    - master
    - tags
